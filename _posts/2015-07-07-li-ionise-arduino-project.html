---
layout: post
title: How to Li-ion'ise your Arduino Project
date: 2015-07-07 23:48:58.000000000 +05:30
type: post
published: true
status: publish
categories:
- Electronics
- Projects
tags: []
meta:
  _edit_last: '6'
  _oembed_b79f8173446bc8c8ed9654f6d5d47c51: "{{unknown}}"
  _wpas_done_all: '1'
  dsq_thread_id: '3970457073'
author:
  login: rupin
  email: rupin.chheda@gmail.com
  display_name: Rupin Chheda
  first_name: Rupin
  last_name: Chheda
---
<p>Its easy, if you ask me!</p>
<p>I was apprehensive before my current project. But no longer. I do not have many photos, but will edit once I have them.</p>
<p>This is a highly involved project!</p>
<p>This is a series of post I am planning to write on projects I am doing, and my learnings from them.</p>
<p><strong>Parts Required</strong></p>
<p>Li-ion charger ( see here http://www.ebay.in/itm/TP4056-5v-1a-Lithium-Battery-Charging-Module-lipo-lion-charger-mini-USB-port-/171827715868?pt=LH_DefaultDomain_203&amp;hash=item2801badf1c)</p>
<p>A Li-ion battery, choose a 1200mAh+ battery for a good amount of backup. Mostly these go for 100/- at Lamington Road.</p>
<p>An Arduino ofcourse, but any microcontroller with a spare ADC pin will suffice.</p>
<p>A couple of resistors, I used 10k and 39k 5% resistors. These are used to create a voltage divider network which senses battery voltage. Dont spend a lot on 1% MFR resistors, it is possible to have accurate results in software.</p>
<p>A switch with three pins, one common, two inputs. this is used to seperate the battery from the arduino into the charger and vice versa.</p>
<p><strong>Firstly, your Arduino can get permanently damaged if the ADC input voltage is greater than the supply voltage.</strong></p>
<p>A Li-ion battery highest voltage should not cross 4.2 volts. Its full discharged when it reaches 3.3V.Â  Effectively, our ADC has to measure this range for the Arduino to know how far along will the battery last.</p>
<p>Here is what has been connected.</p>
<p><strong>TP4056</strong></p>
<p>TP4056 Bat+ to one extreme terminal of switch.</p>
<p>TP4056 Bat- to Battery Negative terminal</p>
<p><strong>Arduino</strong></p>
<p>Arduino 5V pin to other extreme terminal of switch.</p>
<p>Arduino GND to battery Negative terminal</p>
<p><strong>Battery</strong></p>
<p>40k and 10k resistor divider between battery terminals. 40k Resistor connected to Battery positive, 10k to battery GND</p>
<p>Center junction of voltage divider connected to A0 on the Arduino.</p>
<p>&nbsp;</p>
<p><strong>Switch</strong></p>
<p>Center pin of switch connected to Battery (+) terminal.</p>
<p>Okay! I hope you have drawn a good circuit, please verify again.</p>
<p>One flick of switch will disconnect battery from the arduino and connect it to the charger, the other flick will be vice versa.</p>
<p>The TP4056 has two LED's, Red is charging, Blue is Charged</p>
<p><strong>Code</strong></p>
<p>Change the ADC reference to Internal 1.1 V, see here https://www.arduino.cc/en/Reference/AnalogReference</p>
<p>At 4.2v, the A0 pin should ideally see a voltage below 1.1v, about 0.84 volts. This is the premise to choose those resistor values. With the 1.1v reference, this should be easily measurable.</p>
<p>Use the AnalogInOutSerial example, in the Arduino IDE, Change the ADC reference in the setup function, and note values. Lets say it is 650, this is ADC count. This has to be converted to voltage.</p>
<p>A0 pin voltage= 650*1.1/1023=0.69V. With expected 100% accurate resistor values, the battery voltage should be 3.38V( I leave this as an excercise for the reader)</p>
<p>Measure the Voltage of the battery. Lets say its 3.34V.</p>
<p>&nbsp;</p>
<p>Why is there this difference? Because</p>
<p>1) The 1.1V reference is not purely 1.1V</p>
<p>2) The resistor values are not exactly 39k and 10k.</p>
<p>We add correction to this now. Charge the battery, and then let it discharge. Measure a couple of these ADC and Battery voltage values, and find the average multiplier to be provided in the calculation. For our example above, the multiplier is (3.34/3.38)=0.988</p>
<p>You now have the correct battery voltage</p>
<p>&nbsp;</p>
<p>Battery voltage= ADC reading * 1.1 * multiplier * ( sum of resistor values)/1023;</p>
<p>&nbsp;</p>
<p><strong>Problems that can occur while running on batteries</strong></p>
<p>1) Batteries will drain.</p>
<p>2) The Atmega chips have a certain max clock speed at which they run at different voltages. the datasheet will tell you this voltage speed relation. This means that unless you have a very stable voltage, a very strict timing cannot be achieved, because the system clock can be not so accurate</p>
<p>3) Brown Out- If the battery dips too low, the system will reset itself, can be mitigated by changing a couple of fuses.</p>
